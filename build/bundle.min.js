(()=>{



function normalize(query) {
  return query.toLowerCase().trim();
}

function extractNumbers(query) {
  const matches = query.match(/\d+(\.\d+)?/g);
  return matches ? matches.map(Number) : [];
}

function containsAny(query, keywordArray) {
  const normalized = normalize(query);
  return keywordArray.some(keyword => normalized.includes(keyword.toLowerCase()));
}





function validateReviewText(text) {
  
  if (typeof text !== 'string') {
    throw new Error('Review must be text')
  }
  
  
  const trimmed = text.trim()
  
  
  
  if (trimmed.length <= 3) {
    throw new Error('Review must be longer than 3 characters')
  }
  
  
  return trimmed
}


function validateRating(value) {
  
  const number = Number(value)
  
  
  
  if (!Number.isInteger(number) || number < 1 || number > 5) {
    throw new Error('Rating must be an integer between 1 and 5')
  }
  
  
  return number
}


function validateRequired(fieldValue) {
  
  
  const value = typeof fieldValue === 'string' ? fieldValue.trim() : fieldValue
  
  
  
  
  
  if (value === undefined || value === null || value === '') {
    throw new Error('This field is required')
  }
  
  
  return value
}




function daysSince(dateInput) {
  const target = new Date(dateInput)
  const now = new Date()
  const msPerDay = 1000 * 60 * 60 * 24
  return Math.floor((now - target) / msPerDay)
}

function formatDateHuman(dateInput) {
  const date = new Date(dateInput)
  return date.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  })
}




const CAPTCHA_OPTIONS = [
  { id: 'math', prompt: 'What is 4 + 7?', answer: '11' },
  { id: 'color', prompt: "Type the word 'blue'", answer: 'blue' },
  { id: 'pattern', prompt: 'Enter 291', answer: '291' }
]

function generateCaptcha() {
  const index = Math.floor(Math.random() * CAPTCHA_OPTIONS.length)
  return CAPTCHA_OPTIONS[index]
}

function validateCaptcha(input, captchaData) {
  if (!captchaData) {
    throw new Error('CAPTCHA challenge is missing')
  }
  if (String(input).trim().toLowerCase() !== String(captchaData.answer).toLowerCase()) {
    throw new Error('CAPTCHA answer is incorrect')
  }
  return true
}


function isOffline() {
    return !navigator.onLine;
}

function showOfflineBanner() {
    let banner = document.getElementById('offline-banner');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'offline-banner';
        banner.textContent = 'Offline mode: some data may be cached.';
        document.body.prepend(banner);
    }
    banner.classList.add('visible');
}

function hideOfflineBanner() {
    const banner = document.getElementById('offline-banner');
    if (banner) {
        banner.classList.remove('visible');
    }
}

function initOfflineDetection() {
    window.addEventListener('online', hideOfflineBanner);
    window.addEventListener('offline', showOfflineBanner);

    if (isOffline()) {
        showOfflineBanner();
    }
    
    
    window.showOfflineBanner = showOfflineBanner;
}



const KNOWLEDGE = {
  credibility: "Credibility is a score based on review recency, likes, and comments. It helps identify trustworthy reviews.",
  sorting: "You can sort businesses by category, rating, name (A-Z), or newest additions using the dropdown on the home page.",
  deals: "Deals are special offers provided by businesses. They have a start and end date.",
  reviews: "Users can leave reviews with ratings (1-5 stars), text, and photos. You can also like and comment on reviews.",
  recommendations: "Recommendations are based on your favorites, browsing history, and review habits. We suggest businesses you might like!"
}







async function loadBusinesses() {
  let businesses = []
  try {
    
    const res = await fetch(`/data/businesses.json?v=${Date.now()}`)
    if (res.ok) {
      businesses = await res.json()
    }
  } catch (e) {
    
    console.warn('Failed to load businesses.json', e)
  }

  
  const custom = JSON.parse(localStorage.getItem('businesses_custom') || '[]')
  
  const deletedIds = JSON.parse(localStorage.getItem('businesses_deleted_ids') || '[]')

  
  businesses = businesses.filter(b => !deletedIds.includes(b.id))

  
  custom.forEach(c => {
    const idx = businesses.findIndex(b => b.id === c.id)
    if (idx > -1) {
      
      businesses[idx] = c
    } else {
      
      businesses.push(c)
    }
  })

  return businesses
}


async function getBusinessById(id) {
  const businesses = await loadBusinesses()
  
  return businesses.find(b => String(b.id) === String(id)) || null
}


async function getNearbyBusinesses(userLocation) {
  
  if (!userLocation) return loadBusinesses()
  
  const businesses = await loadBusinesses()
  
  return addDistancesToBusinesses(businesses, userLocation, 'M')
}


async function getBusinessesSortedByDistance(userLocation) {
  const businesses = await getNearbyBusinesses(userLocation)
  return sortByDistance(businesses) 
}


async function getBusinessesWithinRadius(userLocation, radiusMiles = 5) {
  const businesses = await getNearbyBusinesses(userLocation)
  return filterByDistance(businesses, radiusMiles)
}




const DEALS_PATH = '/data/deals.json'
let dealsCache = null

async function loadDeals() {
  let deals = []
  if (dealsCache) {
    deals = dealsCache
  } else {
    try {
      const res = await fetch(`${DEALS_PATH}?v=${Date.now()}`)
      if (res.ok) {
        deals = await res.json()
      }
    } catch (e) {
      console.warn('Could not load deals.json', e)
    }
    dealsCache = deals
  }

  const custom = JSON.parse(localStorage.getItem('deals_custom') || '[]')
  const deletedIds = JSON.parse(localStorage.getItem('deals_deleted_ids') || '[]')

  deals = deals.filter(d => !deletedIds.includes(d.id))

  custom.forEach(c => {
    const idx = deals.findIndex(d => d.id === c.id)
    if (idx > -1) {
      deals[idx] = c
    } else {
      deals.push(c)
    }
  })

  return deals
}

function isDealActive(deal) {
  const now = new Date()
  const start = new Date(deal.startDate)
  const end = new Date(deal.endDate)
  return now >= start && now <= end
}

function getDealsForBusiness(businessId) {
  if (!dealsCache) {
    return []
  }
  return dealsCache.filter(deal => String(deal.businessId) === String(businessId))
}

function getActiveDeals() {
  if (!dealsCache) {
    return []
  }
  return dealsCache.filter(isDealActive)
}




const REVIEW_PATH = '/data/reviews.json'


let originalReviewsCache = null


function normalizeReview(review) {
  return {
    ...review,
    likes: Number(review.likes) || 0,
    comments: Array.isArray(review.comments) ? review.comments : [],
    image: review.image || 'review-placeholder.svg'
  }
}

async function ensureOriginalReviews() {
  if (originalReviewsCache) {
    return originalReviewsCache
  }
  try {
    
    const res = await fetch(`${REVIEW_PATH}?v=${Date.now()}`)
    if (res.ok) {
      const json = await res.json()
      originalReviewsCache = json.map(normalizeReview)
    } else {
      originalReviewsCache = []
    }
  } catch (e) {
    console.warn('Unable to load reviews', e)
    originalReviewsCache = []
  }
  return originalReviewsCache
}

function getCustomReviews() {
  const stored = JSON.parse(localStorage.getItem('reviews_custom') || '[]')
  return stored.map(normalizeReview)
}

function persistCustomReviews(customReviews) {
  localStorage.setItem('reviews_custom', JSON.stringify(customReviews))
}

function upsertCustomReview(review) {
  const custom = getCustomReviews()
  const index = custom.findIndex(r => r.id === review.id)
  const normalized = normalizeReview(review)
  if (index >= 0) {
    custom[index] = normalized
  } else {
    custom.push(normalized)
  }
  persistCustomReviews(custom)
  return normalized
}

async function mergeReviews() {
  const original = await ensureOriginalReviews()
  const custom = getCustomReviews()
  const deletedIds = JSON.parse(localStorage.getItem('reviews_deleted_ids') || '[]')
  
  const customById = new Map(custom.map(review => [review.id, review]))

  let merged = original.map(review => customById.get(review.id) || review)
  const additional = custom.filter(review => !original.some(orig => orig.id === review.id))
  
  merged = [...merged, ...additional]
  
  return merged.filter(r => !deletedIds.includes(r.id))
}

async function loadReviews() {
  const reviews = await mergeReviews()
  const hiddenIds = JSON.parse(localStorage.getItem('reviews_hidden') || '[]')
  return reviews.filter(r => !hiddenIds.includes(r.id))
}

async function getReviewsForBusiness(businessId) {
  const reviews = await mergeReviews()
  return reviews.filter(review => String(review.businessId) === String(businessId))
}

async function addReview(businessId, reviewObj) {
  const newReview = {
    id: Date.now(),
    businessId,
    text: reviewObj.text,
    rating: reviewObj.rating,
    likes: 0,
    comments: [],
    image: reviewObj.image || 'review-placeholder.svg',
    date: new Date().toISOString()
  }
  return upsertCustomReview(newReview)
}

async function likeReview(reviewId) {
  const reviews = await mergeReviews()
  const review = reviews.find(r => String(r.id) === String(reviewId))
  if (!review) {
    throw new Error('Review not found')
  }
  const updated = { ...review, likes: (Number(review.likes) || 0) + 1 }
  return upsertCustomReview(updated)
}

async function commentOnReview(reviewId, commentText) {
  const reviews = await mergeReviews()
  const review = reviews.find(r => String(r.id) === String(reviewId))
  if (!review) {
    throw new Error('Review not found')
  }
  const updated = {
    ...review,
    comments: [...(Array.isArray(review.comments) ? review.comments : []), commentText]
  }
  return upsertCustomReview(updated)
}

function getUserReviews() {
  return getCustomReviews()
}





function saveFavorite(id) {
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]')
  if (!favorites.includes(id)) {
    favorites.push(id)
    localStorage.setItem('favorites', JSON.stringify(favorites))
  }
}


function removeFavorite(id) {
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]')
  const updated = favorites.filter(favId => favId !== id)
  localStorage.setItem('favorites', JSON.stringify(updated))
}


function getFavorites() {
  return JSON.parse(localStorage.getItem('favorites') || '[]')
}


function isFavorite(id) {
  const favorites = getFavorites()
  return favorites.includes(id)
}



function recordView(businessId) {
  const history = getHistory()
  history.push({ businessId, timestamp: Date.now() })
  
  if (history.length > 50) {
    history.shift()
  }
  localStorage.setItem('history', JSON.stringify(history))
}

function getHistory() {
  return JSON.parse(localStorage.getItem('history') || '[]')
}

function getMostViewedCategories(allBusinesses) {
  const history = getHistory()
  const categoryCounts = {}

  history.forEach(entry => {
    const business = allBusinesses.find(b => String(b.id) === String(entry.businessId))
    if (business && business.category) {
      categoryCounts[business.category] = (categoryCounts[business.category] || 0) + 1
    }
  })

  
  return Object.entries(categoryCounts)
    .sort((a, b) => b[1] - a[1])
    .map(entry => entry[0])
}






function getCommentsCount(review) {
  if (Array.isArray(review.comments)) {
    return review.comments.length
  }
  if (typeof review.comments === 'number') {
    return review.comments
  }
  return 0
}

function getRecencyWeight(review) {
  const days = daysSince(review.date)
  if (days < 7) return 5
  if (days < 30) return 3
  return 1
}

function calculateCredibility(reviewObj) {
  const likes = Number(reviewObj.likes) || 0
  const comments = getCommentsCount(reviewObj)
  const recencyWeight = getRecencyWeight(reviewObj)
  return likes * 2 + comments + recencyWeight
}

function sortReviewsByCredibility(reviews) {
  return [...reviews].sort((a, b) => {
    const scoreA = calculateCredibility(a)
    const scoreB = calculateCredibility(b)
    if (scoreB !== scoreA) {
      return scoreB - scoreA
    }
    const dateDiff = new Date(b.date) - new Date(a.date)
    if (dateDiff !== 0) {
      return dateDiff
    }
    return (Number(b.rating) || 0) - (Number(a.rating) || 0)
  })
}









const WEIGHTS = {
  CATEGORY_MATCH: 20,
  RATING_MULTIPLIER: 3,
  CREDIBILITY_MULTIPLIER: 1.5,
  ACTIVE_DEAL: 10,
  HISTORY_MATCH: 15
}

async function getUserPreferences() {
  const businesses = await loadBusinesses()
  const favorites = getFavorites()
  const userReviews = getUserReviews()
  const historyCategories = getMostViewedCategories(businesses)

  const preferredCategories = new Set()

  
  favorites.forEach(favId => {
    const b = businesses.find(biz => String(biz.id) === String(favId))
    if (b) preferredCategories.add(b.category)
  })

  
  userReviews.forEach(review => {
    const b = businesses.find(biz => String(biz.id) === String(review.businessId))
    if (b) preferredCategories.add(b.category)
  })

  
  historyCategories.slice(0, 3).forEach(cat => preferredCategories.add(cat))

  return {
    preferredCategories: Array.from(preferredCategories),
    favorites: new Set(favorites.map(String)),
    historyCategories: new Set(historyCategories.slice(0, 3)) 
  }
}

async function scoreBusiness(business, preferences, reviewsForBusiness) {
  let score = 0
  const reasons = []

  
  if (preferences.preferredCategories.includes(business.category)) {
    score += WEIGHTS.CATEGORY_MATCH
    reasons.push(`Matches your interest in ${business.category}`)
  }

  
  const ratingScore = (business.rating || 0) * WEIGHTS.RATING_MULTIPLIER
  score += ratingScore
  if (business.rating >= 4.5) {
    reasons.push('Highly rated by community')
  }

  
  
  let avgCredibility = 0
  if (reviewsForBusiness && reviewsForBusiness.length > 0) {
    const totalCred = reviewsForBusiness.reduce((sum, r) => sum + calculateCredibility(r), 0)
    avgCredibility = totalCred / reviewsForBusiness.length
  }
  score += avgCredibility * WEIGHTS.CREDIBILITY_MULTIPLIER
  if (avgCredibility > 5) { 
    reasons.push('High credibility score')
  }

  
  const activeDeals = getActiveDeals()
  const hasDeal = activeDeals.some(d => String(d.businessId) === String(business.id))
  if (hasDeal) {
    score += WEIGHTS.ACTIVE_DEAL
    reasons.push('Has active deal')
  }

  
  if (preferences.historyCategories.has(business.category)) {
    score += WEIGHTS.HISTORY_MATCH
    
    if (!reasons.some(r => r.includes(`interest in ${business.category}`))) {
      reasons.push('Based on your browsing history')
    }
  }

  return { score, reasons }
}

async function getRecommendedBusinesses(limit = 5) {
  const businesses = await loadBusinesses()
  const preferences = await getUserPreferences()
  
  
  
  
  
  
  const { loadReviews } = await import('./reviewService.js')
  const allReviews = await loadReviews()

  const scored = []

  for (const business of businesses) {
    
    if (preferences.favorites.has(String(business.id))) {
      continue
    }

    const businessReviews = allReviews.filter(r => String(r.businessId) === String(business.id))
    const { score, reasons } = await scoreBusiness(business, preferences, businessReviews)
    
    scored.push({ business, score, reasons })
  }

  
  scored.sort((a, b) => b.score - a.score)

  return scored.slice(0, limit)
}


function calculateBusinessStats(businesses, reviews) {
    
    const reviewCounts = {};
    reviews.forEach(r => {
        reviewCounts[r.businessId] = (reviewCounts[r.businessId] || 0) + 1;
    });

    const mostReviewed = businesses.map(b => ({
        name: b.name,
        count: reviewCounts[b.id] || 0
    })).sort((a, b) => b.count - a.count).slice(0, 5);

    
    const highestRated = businesses.map(b => ({
        name: b.name,
        rating: b.rating
    })).sort((a, b) => b.rating - a.rating).slice(0, 5);

    return { mostReviewed, highestRated };
}

function calculateReviewStats(reviews) {
    
    return { total: reviews.length };
}

function calculateDealStats(deals) {
    
    const now = new Date();
    const active = deals.filter(d => new Date(d.endDate) >= now).length;
    return { active, total: deals.length };
}

function calculateCategoryStats(businesses) {
    const counts = {};
    businesses.forEach(b => {
        counts[b.category] = (counts[b.category] || 0) + 1;
    });
    return Object.entries(counts).map(([name, count]) => ({ name, count }));
}


const ADMIN_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; 

async function loginAdmin(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

    if (hashHex === ADMIN_HASH) {
        localStorage.setItem("isAdmin", "true");
        return true;
    }
    return false;
}

function logoutAdmin() {
    localStorage.removeItem("isAdmin");
    window.location.hash = '#/admin';
    window.location.reload();
}

function isAdmin() {
    return localStorage.getItem("isAdmin") === "true";
}







function getLocalData(key) {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
}

function setLocalData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}


async function getMergedBusinesses() {
    return await loadBusinesses();
}

function saveBusiness(business) {
    const custom = getLocalData('businesses_custom');
    const index = custom.findIndex(b => b.id === business.id);
    if (index !== -1) {
        custom[index] = business;
    } else {
        custom.push(business);
    }
    setLocalData('businesses_custom', custom);
}

function deleteBusiness(id) {
    const deletedIds = getLocalData('businesses_deleted_ids');
    if (!deletedIds.includes(id)) {
        deletedIds.push(id);
        setLocalData('businesses_deleted_ids', deletedIds);
    }
    
    const custom = getLocalData('businesses_custom');
    const newCustom = custom.filter(b => b.id !== id);
    setLocalData('businesses_custom', newCustom);
}


async function getMergedDeals() {
    return await loadDeals();
}

function saveDeal(deal) {
    const custom = getLocalData('deals_custom');
    const index = custom.findIndex(d => d.id === deal.id);
    if (index !== -1) {
        custom[index] = deal;
    } else {
        custom.push(deal);
    }
    setLocalData('deals_custom', custom);
}

function deleteDeal(id) {
    const deletedIds = getLocalData('deals_deleted_ids');
    if (!deletedIds.includes(id)) {
        deletedIds.push(id);
        setLocalData('deals_deleted_ids', deletedIds);
    }
    
    const custom = getLocalData('deals_custom');
    const newCustom = custom.filter(d => d.id !== id);
    setLocalData('deals_custom', newCustom);
}


async function getMergedReviews() {
    
    
    
    const reviews = await mergeReviews();
    const hiddenIds = getLocalData('reviews_hidden');
    
    return reviews.map(r => ({
        ...r,
        isHidden: hiddenIds.includes(r.id)
    }));
}

function toggleReviewVisibility(id) {
    const hiddenIds = getLocalData('reviews_hidden');
    const index = hiddenIds.indexOf(id);
    if (index !== -1) {
        hiddenIds.splice(index, 1);
    } else {
        hiddenIds.push(id);
    }
    setLocalData('reviews_hidden', hiddenIds);
}

function deleteReview(id) {
    const deletedIds = getLocalData('reviews_deleted_ids');
    if (!deletedIds.includes(id)) {
        deletedIds.push(id);
        setLocalData('reviews_deleted_ids', deletedIds);
    }
}


async function runIntegrityChecks() {
    const businesses = await getMergedBusinesses();
    const deals = await getMergedDeals();
    const reviews = await getMergedReviews();
    
    const issues = [];

    
    const checkDuplicates = (items, type) => {
        const ids = items.map(i => i.id);
        const duplicates = ids.filter((item, index) => ids.indexOf(item) !== index);
        if (duplicates.length > 0) {
            issues.push(`Duplicate ${type} IDs found: ${duplicates.join(', ')}`);
        }
    };
    checkDuplicates(businesses, 'Business');
    checkDuplicates(deals, 'Deal');
    checkDuplicates(reviews, 'Review');

    
    businesses.forEach(b => {
        if (!b.name) issues.push(`Business ${b.id} missing name`);
        if (!b.category) issues.push(`Business ${b.id} missing category`);
    });

    
    deals.forEach(d => {
        if (new Date(d.endDate) < new Date(d.startDate)) {
            issues.push(`Deal ${d.id} has endDate before startDate`);
        }
    });

    
    const businessIds = businesses.map(b => b.id);
    
    reviews.forEach(r => {
        if (!businessIds.includes(r.businessId)) {
            issues.push(`Review ${r.id} references missing businessId ${r.businessId}`);
        }
    });

    deals.forEach(d => {
        if (!businessIds.includes(d.businessId)) {
            issues.push(`Deal ${d.id} references missing businessId ${d.businessId}`);
        }
    });

    return issues;
}


async function exportData(type) {
    let data;
    if (type === 'businesses') data = await getMergedBusinesses();
    if (type === 'deals') data = await getMergedDeals();
    if (type === 'reviews') data = await getMergedReviews();
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    return URL.createObjectURL(blob);
}

function importData(jsonString, type) {
    try {
        const data = JSON.parse(jsonString);
        if (!Array.isArray(data)) throw new Error("Imported data must be an array");
        
        
        if (data.length > 0) {
            if (type === 'businesses' && !data[0].name) throw new Error("Invalid business schema");
            if (type === 'deals' && !data[0].title) throw new Error("Invalid deal schema");
            if (type === 'reviews' && !data[0].text) throw new Error("Invalid review schema");
        }

        
        if (type === 'businesses') setLocalData('businesses_custom', data);
        if (type === 'deals') setLocalData('deals_custom', data);
        if (type === 'reviews') setLocalData('reviews_custom', data);

        return { success: true };
    } catch (e) {
        return { success: false, error: e.message };
    }
}









const INTENTS = {
  FIND_BY_CATEGORY: ['food', 'restaurant', 'coffee', 'retail', 'book', 'gym', 'fitness', 'shop'],
  FIND_BY_DEAL: ['deal', 'discount', 'coupon', 'offer', 'sale'],
  FIND_BY_RATING: ['best', 'top', 'rated', 'rating', 'stars'],
  FIND_BY_FAVORITES: ['favorite', 'saved', 'bookmark', 'liked'],
  HELP: ['help', 'what can you do', 'support', 'assist'],
  FEATURE_INFO: ['what is', 'how to', 'explain', 'sorting', 'credibility'],
  RECOMMEND: ['recommend', 'suggest', 'what should i', 'for me']
}

function detectIntent(query) {
  const normalized = normalize(query)

  if (containsAny(normalized, INTENTS.HELP)) return 'HELP'
  if (containsAny(normalized, INTENTS.FEATURE_INFO)) return 'FEATURE_INFO'
  if (containsAny(normalized, INTENTS.RECOMMEND)) return 'RECOMMEND'
  if (containsAny(normalized, INTENTS.FIND_BY_FAVORITES)) return 'FIND_BY_FAVORITES'
  if (containsAny(normalized, INTENTS.FIND_BY_DEAL)) return 'FIND_BY_DEAL'
  if (containsAny(normalized, INTENTS.FIND_BY_RATING)) return 'FIND_BY_RATING'
  if (containsAny(normalized, INTENTS.FIND_BY_CATEGORY)) return 'FIND_BY_CATEGORY'

  return 'UNKNOWN'
}

function extractEntities(query) {
  const normalized = normalize(query)
  const numbers = extractNumbers(query)
  
  let category = null
  if (containsAny(normalized, ['food', 'restaurant'])) category = 'Food'
  else if (containsAny(normalized, ['coffee'])) category = 'Coffee' 
  else if (containsAny(normalized, ['retail', 'shop', 'store', 'book'])) category = 'Retail'
  else if (containsAny(normalized, ['fitness', 'gym'])) category = 'Fitness'

  
  let rating = null
  if (numbers.length > 0 && (normalized.includes('star') || normalized.includes('rating') || normalized.includes('rated'))) {
    rating = numbers[0]
  }

  return {
    category,
    rating,
    deal: containsAny(normalized, INTENTS.FIND_BY_DEAL)
  }
}

async function getBotResponse(intent, entities) {
  const businesses = await loadBusinesses()

  switch (intent) {
    case 'FIND_BY_CATEGORY':
      if (!entities.category) {
        return { text: "I can find businesses by category. Try asking for 'food', 'retail', or 'fitness'." }
      }
      const catMatches = businesses.filter(b => 
        b.category.toLowerCase() === entities.category.toLowerCase() || 
        (b.subcategory && b.subcategory.toLowerCase().includes(entities.category.toLowerCase()))
      )
      if (catMatches.length === 0) return { text: `No businesses found in ${entities.category}.` }
      return { 
        text: `Here are some ${entities.category} businesses:`, 
        data: catMatches 
      }

    case 'FIND_BY_DEAL':
      const deals = getActiveDeals()
      if (deals.length === 0) return { text: "There are no active deals right now." }
      const dealBusinessIds = deals.map(d => String(d.businessId))
      const dealBusinesses = businesses.filter(b => dealBusinessIds.includes(String(b.id)))
      return { 
        text: "Here are businesses with active deals:", 
        data: dealBusinesses 
      }

    case 'FIND_BY_RATING':
      const minRating = entities.rating || 4.5
      const topRated = businesses.filter(b => b.rating >= minRating).sort((a, b) => b.rating - a.rating)
      if (topRated.length === 0) return { text: `No businesses found with rating ${minRating} or higher.` }
      return { 
        text: `Here are the top rated businesses (${minRating}+ stars):`, 
        data: topRated 
      }

    case 'FIND_BY_FAVORITES':
      const favIds = getFavorites().map(String)
      if (favIds.length === 0) return { text: "You haven't saved any favorites yet." }
      const favBusinesses = businesses.filter(b => favIds.includes(String(b.id)))
      return { 
        text: "Here are your favorite businesses:", 
        data: favBusinesses 
      }

    case 'RECOMMEND':
      const recommendations = await getRecommendedBusinesses(3)
      if (recommendations.length === 0) return { text: "I don't have enough data to recommend anything yet. Try browsing or adding favorites!" }
      
      const recBusinesses = recommendations.map(r => r.business)
      return { 
        text: "Based on your preferences, I recommend:", 
        data: recBusinesses 
      }

    case 'FEATURE_INFO':
      if (containsAny(JSON.stringify(entities), ['credibility'])) return { text: KNOWLEDGE.credibility } 
      
      
      
      return { text: "I can explain: Credibility, Sorting, Deals, Reviews, and Recommendations. What would you like to know about?" }

    case 'HELP':
      return { text: "I can help you find businesses, show deals, list your favorites, or explain features. Try asking 'Show me coffee shops' or 'Any deals?'." }

    case 'UNKNOWN':
    default:
      return { text: "I didn't understand that. Try asking about categories, deals, or your favorites." }
  }
}

async function handleUserQuery(query) {
  const intent = detectIntent(query)
  const entities = extractEntities(query)
  
  
  if (intent === 'FEATURE_INFO') {
    const normalized = normalize(query)
    if (normalized.includes('credibility')) return { text: KNOWLEDGE.credibility }
    if (normalized.includes('sort')) return { text: KNOWLEDGE.sorting }
    if (normalized.includes('deal')) return { text: KNOWLEDGE.deals }
    if (normalized.includes('review')) return { text: KNOWLEDGE.reviews }
    if (normalized.includes('recommend')) return { text: KNOWLEDGE.recommendations }
  }

  return await getBotResponse(intent, entities)
}




function businessCard(business) {
  
  const card = document.createElement('div')
  card.className = "business-card"
  
  
  card.setAttribute('role', 'article')
  card.setAttribute('aria-label', `View details for ${business.name}`)

  
  const imageUrl = business.image.startsWith('http') ? business.image : `/assets/${business.image}`
  card.innerHTML = `
    <img src="${imageUrl}" alt="${business.name}" loading="lazy">
    <div class="mt-sm">
      <div class="flex-between mb-sm">
        <span class="badge badge-light">${business.category}</span>
        <span class="text-warning font-bold">‚òÖ ${business.rating}</span>
      </div>
      <h3 class="mb-sm">${business.name}</h3>
      <p class="text-light text-sm mb-md line-clamp-2">${business.description}</p>
      <button class="button button-outline w-full">View Details</button>
    </div>
  `

  
  card.onclick = () => {
    location.hash = `#/business/${business.id}`
  }

  
  card.tabIndex = 0
  card.onkeydown = (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault() 
      location.hash = `#/business/${business.id}`
    }
  }

  return card
}





function renderReviewCard(review) {
    const card = document.createElement('div');
    card.className = 'review-card';
    
    
    const imgUrl = review.image ? (review.image.startsWith('http') ? review.image : `assets/${review.image}`) : null
    const img = imgUrl ? `<img data-src="${imgUrl}" alt="Review Image" class="review-image lazy-load" loading="lazy">` : '';

    card.innerHTML = `
        <div class="review-header">
            <div class="review-rating">
                ${'‚òÖ'.repeat(Math.floor(review.rating))}${'‚òÜ'.repeat(5 - Math.floor(review.rating))}
            </div>
            <span class="review-date">${new Date(review.date).toLocaleDateString()}</span>
        </div>
        <p class="review-text">"${review.text}"</p>
        ${img}
        <div class="review-footer">
            <button class="btn-like" data-id="${review.id}">
                ‚ù§Ô∏è <span class="like-count">${review.likes || 0}</span>
            </button>
            <button class="btn-comment" data-id="${review.id}">üí¨ Comment</button>
        </div>
        <div class="comments-section" id="comments-${review.id}">
            ${(review.comments || []).map(c => `<div class="comment">${c}</div>`).join('')}
        </div>
    `;

    
    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const imgEl = entry.target;
                imgEl.src = imgEl.dataset.src;
                imgEl.classList.remove('lazy-load');
                obs.unobserve(imgEl);
            }
        });
    });

    const lazyImg = card.querySelector('.lazy-load');
    if (lazyImg) observer.observe(lazyImg);

    return card;
}


function recommendationCard(recommendation) {
  const { business, reasons } = recommendation
  
  const card = document.createElement('div')
  card.className = 'recommendation-card'
  card.setAttribute('role', 'article')
  card.setAttribute('aria-label', `Recommended: ${business.name}`)
  
  const reasonText = reasons.slice(0, 2).join(' ‚Ä¢ ')
  const imageUrl = business.image.startsWith('http') ? business.image : `/assets/${business.image}`

  card.innerHTML = `
    <div class="badge badge-primary" style="position: absolute; top: 10px; right: 10px; z-index: 1;">Recommended</div>
    <img src="${imageUrl}" alt="${business.name}" loading="lazy">
    <div class="mt-sm">
      <h3 class="mb-sm">${business.name}</h3>
      <p class="text-light text-sm mb-sm">${business.category}</p>
      <p class="text-sm text-main" style="font-style: italic;">üí° ${reasonText}</p>
    </div>
  `

  card.onclick = () => {
    location.hash = `#/business/${business.id}`
  }
  
  card.tabIndex = 0
  card.onkeydown = (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault()
      location.hash = `#/business/${business.id}`
    }
  }

  return card
}







function initChatbot() {
  
  const container = document.getElementById('chatbot-container')
  
  
  if (!container) return

  
  renderChatbot(container)
}


function renderChatbot(container) {
  
  container.innerHTML = `
    <button id="chatbot-toggle" class="chatbot-toggle" aria-label="Open Chat Assistant">üí¨</button>
    <div id="chatbot-window" class="chatbot-window" style="display: none;" role="dialog" aria-label="Chat Assistant">
      <div class="chatbot-header">
        <span>Assistant</span>
        <button id="chatbot-close" class="chatbot-close" aria-label="Close Chat">√ó</button>
      </div>
      <div id="chatbot-messages" class="chatbot-messages" role="log" aria-live="polite"></div>
      <form id="chatbot-form" class="chatbot-input-area">
        <input type="text" id="chatbot-input" placeholder="Ask me anything..." autocomplete="off" aria-label="Chat message" />
        <button type="submit" aria-label="Send message">‚û§</button>
      </form>
    </div>
  `

  
  const toggleBtn = document.getElementById('chatbot-toggle')
  const closeBtn = document.getElementById('chatbot-close')
  const windowEl = document.getElementById('chatbot-window')
  const form = document.getElementById('chatbot-form')
  const input = document.getElementById('chatbot-input')
  const messagesContainer = document.getElementById('chatbot-messages')

  
  addBotMessage(messagesContainer, "Hi! I can help you find businesses, deals, or explain features. Try asking 'Show me coffee shops'!")

  
  toggleBtn.addEventListener('click', () => {
    const isHidden = windowEl.style.display === 'none'
    windowEl.style.display = isHidden ? 'flex' : 'none'
    if (isHidden) {
      input.focus() 
    }
  })

  
  closeBtn.addEventListener('click', () => {
    windowEl.style.display = 'none'
  })

  
  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    const text = input.value.trim()
    if (!text) return

    addUserMessage(messagesContainer, text)
    input.value = ''

    
    setTimeout(async () => {
      const response = await handleUserQuery(text)
      addBotMessage(messagesContainer, response.text, response.data)
    }, 300)
  })
}


function addUserMessage(container, text) {
  const msgDiv = document.createElement('div')
  msgDiv.className = 'message user'
  msgDiv.textContent = text
  container.appendChild(msgDiv)
  scrollToBottom(container)
}


function addBotMessage(container, text, data = null) {
  const msgDiv = document.createElement('div')
  msgDiv.className = 'message bot'
  
  const textP = document.createElement('p')
  textP.style.margin = '0'
  textP.textContent = text
  msgDiv.appendChild(textP)

  
  if (data && Array.isArray(data) && data.length > 0) {
    const list = document.createElement('div')
    list.className = 'chat-business-list'
    
    data.forEach(item => {
      const itemDiv = document.createElement('div')
      itemDiv.className = 'chat-business-item'
      itemDiv.innerHTML = `<strong>${item.name}</strong>${item.category} ${item.rating ? '‚≠ê ' + item.rating : ''}`
      itemDiv.onclick = () => {
        location.hash = `#/business/${item.id}`
        
        
      }
      list.appendChild(itemDiv)
    })
    msgDiv.appendChild(list)
  }

  container.appendChild(msgDiv)
  scrollToBottom(container)
}


function scrollToBottom(container) {
  container.scrollTop = container.scrollHeight
}





async function renderAnalytics(container) {
    const businesses = await getMergedBusinesses();
    const reviews = await getMergedReviews();
    const deals = await getMergedDeals();

    const bizStats = calculateBusinessStats(businesses, reviews);
    const catStats = calculateCategoryStats(businesses);

    container.innerHTML = `
        <div class="admin-section">
            <h2>Analytics Dashboard</h2>
            <div class="analytics-grid">
                <div class="chart-container">
                    <h3>Most Reviewed Businesses</h3>
                    <canvas id="chart-reviews" width="300" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Business Categories</h3>
                    <canvas id="chart-categories" width="300" height="200"></canvas>
                </div>
            </div>
        </div>
    `;

    
    const ctxReviews = container.querySelector('#chart-reviews').getContext('2d');
    drawBarChart(ctxReviews, bizStats.mostReviewed.map(b => b.name), bizStats.mostReviewed.map(b => b.count));

    
    const ctxCats = container.querySelector('#chart-categories').getContext('2d');
    drawPieChart(ctxCats, catStats);
}

function drawBarChart(ctx, labels, data) {
    const width = ctx.canvas.width;
    const height = ctx.canvas.height;
    const maxVal = Math.max(...data, 1);
    const barWidth = (width - 40) / data.length;

    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = '#ff6b00';
    data.forEach((val, i) => {
        const barHeight = (val / maxVal) * (height - 40);
        ctx.fillRect(20 + i * barWidth, height - 20 - barHeight, barWidth - 10, barHeight);
        
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.fillText(val, 20 + i * barWidth + (barWidth-10)/2 - 3, height - 20 - barHeight - 5);
        ctx.fillText(labels[i].substring(0, 5), 20 + i * barWidth, height - 5);
        ctx.fillStyle = '#ff6b00';
    });
}

function drawPieChart(ctx, data) {
    const width = ctx.canvas.width;
    const height = ctx.canvas.height;
    const total = data.reduce((sum, item) => sum + item.count, 0);
    let startAngle = 0;
    const colors = ['#ff6b00', '#333', '#666', '#999', '#ccc'];

    data.forEach((item, i) => {
        const sliceAngle = (item.count / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(width/2, height/2);
        ctx.arc(width/2, height/2, height/2 - 20, startAngle, startAngle + sliceAngle);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        startAngle += sliceAngle;
    });
    
    
    let y = 10;
    data.forEach((item, i) => {
        ctx.fillStyle = colors[i % colors.length];
        ctx.fillRect(10, y, 10, 10);
        ctx.fillStyle = '#000';
        ctx.fillText(`${item.name} (${item.count})`, 25, y + 8);
        y += 15;
    });
}




async function renderBusinessAdmin(container) {
    const businesses = await getMergedBusinesses();
    
    container.innerHTML = `
        <div class="admin-section">
            <h2>Manage Businesses</h2>
            <button id="add-business-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Add Business</button>
            
            <div id="business-form-container" style="display:none; margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd;">
                <h3 id="form-title">Add/Edit Business</h3>
                <form id="business-form">
                    <input type="hidden" id="biz-id">
                    <div class="admin-form-group">
                        <label>Name</label>
                        <input type="text" id="biz-name" required>
                    </div>
                    <div class="admin-form-group">
                        <label>Category</label>
                        <input type="text" id="biz-category" required>
                    </div>
                    <div class="admin-form-group">
                        <label>Rating (0-5)</label>
                        <input type="number" id="biz-rating" min="0" max="5" step="0.1" required>
                    </div>
                    <div class="admin-form-group">
                        <label>Description</label>
                        <textarea id="biz-desc" required minlength="5"></textarea>
                    </div>
                    <div class="admin-form-group">
                        <label>Image Filename</label>
                        <input type="text" id="biz-image" value="placeholder.jpg">
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="cancel-biz-btn" class="btn btn-secondary">Cancel</button>
                </form>
                <div id="biz-error" class="error-message"></div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Rating</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="business-table-body">
                    ${businesses.map(b => `
                        <tr>
                            <td>${b.id}</td>
                            <td>${b.name}</td>
                            <td>${b.category}</td>
                            <td>${b.rating}</td>
                            <td class="admin-actions">
                                <button class="btn-sm btn-edit" data-id="${b.id}">Edit</button>
                                <button class="btn-sm btn-danger" data-id="${b.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    
    const formContainer = container.querySelector('#business-form-container');
    const form = container.querySelector('#business-form');
    const addBtn = container.querySelector('#add-business-btn');
    const cancelBtn = container.querySelector('#cancel-biz-btn');
    const errorDiv = container.querySelector('#biz-error');

    addBtn.addEventListener('click', () => {
        form.reset();
        container.querySelector('#biz-id').value = '';
        container.querySelector('#form-title').textContent = 'Add Business';
        formContainer.style.display = 'block';
    });

    cancelBtn.addEventListener('click', () => {
        formContainer.style.display = 'none';
        errorDiv.textContent = '';
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = container.querySelector('#biz-id').value;
        const name = container.querySelector('#biz-name').value;
        const category = container.querySelector('#biz-category').value;
        const rating = parseFloat(container.querySelector('#biz-rating').value);
        const description = container.querySelector('#biz-desc').value;
        const image = container.querySelector('#biz-image').value;

        if (description.length < 5) {
            errorDiv.textContent = "Description must be at least 5 characters.";
            return;
        }

        const newBiz = {
            id: id ? parseInt(id) : Date.now(), 
            name,
            category,
            rating,
            description,
            image
        };

        saveBusiness(newBiz);
        renderBusinessAdmin(container); 
    });

    container.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = parseInt(btn.dataset.id);
            const biz = businesses.find(b => b.id === id);
            if (biz) {
                container.querySelector('#biz-id').value = biz.id;
                container.querySelector('#biz-name').value = biz.name;
                container.querySelector('#biz-category').value = biz.category;
                container.querySelector('#biz-rating').value = biz.rating;
                container.querySelector('#biz-desc').value = biz.description;
                container.querySelector('#biz-image').value = biz.image;
                container.querySelector('#form-title').textContent = 'Edit Business';
                formContainer.style.display = 'block';
            }
        });
    });

    container.querySelectorAll('.btn-danger').forEach(btn => {
        btn.addEventListener('click', () => {
            if(confirm('Are you sure?')) {
                deleteBusiness(parseInt(btn.dataset.id));
                renderBusinessAdmin(container);
            }
        });
    });
}




async function renderDealAdmin(container) {
    const deals = await getMergedDeals();
    
    container.innerHTML = `
        <div class="admin-section">
            <h2>Manage Deals</h2>
            <button id="add-deal-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Add Deal</button>
            
            <div id="deal-form-container" style="display:none; margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd;">
                <h3 id="deal-form-title">Add/Edit Deal</h3>
                <form id="deal-form">
                    <input type="hidden" id="deal-id">
                    <div class="admin-form-group">
                        <label>Business ID</label>
                        <input type="number" id="deal-biz-id" required>
                    </div>
                    <div class="admin-form-group">
                        <label>Title</label>
                        <input type="text" id="deal-title" required>
                    </div>
                    <div class="admin-form-group">
                        <label>Description</label>
                        <textarea id="deal-desc" required></textarea>
                    </div>
                    <div class="admin-form-group">
                        <label>Start Date</label>
                        <input type="date" id="deal-start" required>
                    </div>
                    <div class="admin-form-group">
                        <label>End Date</label>
                        <input type="date" id="deal-end" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="cancel-deal-btn" class="btn btn-secondary">Cancel</button>
                </form>
                <div id="deal-error" class="error-message"></div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Business ID</th>
                        <th>Title</th>
                        <th>Dates</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deal-table-body">
                    ${deals.map(d => `
                        <tr>
                            <td>${d.id}</td>
                            <td>${d.businessId}</td>
                            <td>${d.title}</td>
                            <td>${d.startDate} to ${d.endDate}</td>
                            <td class="admin-actions">
                                <button class="btn-sm btn-edit" data-id="${d.id}">Edit</button>
                                <button class="btn-sm btn-danger" data-id="${d.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    const formContainer = container.querySelector('#deal-form-container');
    const form = container.querySelector('#deal-form');
    const addBtn = container.querySelector('#add-deal-btn');
    const cancelBtn = container.querySelector('#cancel-deal-btn');
    const errorDiv = container.querySelector('#deal-error');

    addBtn.addEventListener('click', () => {
        form.reset();
        container.querySelector('#deal-id').value = '';
        container.querySelector('#deal-form-title').textContent = 'Add Deal';
        formContainer.style.display = 'block';
    });

    cancelBtn.addEventListener('click', () => {
        formContainer.style.display = 'none';
        errorDiv.textContent = '';
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = container.querySelector('#deal-id').value;
        const businessId = parseInt(container.querySelector('#deal-biz-id').value);
        const title = container.querySelector('#deal-title').value;
        const description = container.querySelector('#deal-desc').value;
        const startDate = container.querySelector('#deal-start').value;
        const endDate = container.querySelector('#deal-end').value;

        if (new Date(endDate) < new Date(startDate)) {
            errorDiv.textContent = "End date must be after start date.";
            return;
        }

        const newDeal = {
            id: id ? parseInt(id) : Date.now(),
            businessId,
            title,
            description,
            startDate,
            endDate
        };

        saveDeal(newDeal);
        renderDealAdmin(container);
    });

    container.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = parseInt(btn.dataset.id);
            const deal = deals.find(d => d.id === id);
            if (deal) {
                container.querySelector('#deal-id').value = deal.id;
                container.querySelector('#deal-biz-id').value = deal.businessId;
                container.querySelector('#deal-title').value = deal.title;
                container.querySelector('#deal-desc').value = deal.description;
                container.querySelector('#deal-start').value = deal.startDate;
                container.querySelector('#deal-end').value = deal.endDate;
                container.querySelector('#deal-form-title').textContent = 'Edit Deal';
                formContainer.style.display = 'block';
            }
        });
    });

    container.querySelectorAll('.btn-danger').forEach(btn => {
        btn.addEventListener('click', () => {
            if(confirm('Are you sure?')) {
                deleteDeal(parseInt(btn.dataset.id));
                renderDealAdmin(container);
            }
        });
    });
}




async function renderReviewAdmin(container) {
    const reviews = await getMergedReviews();
    
    container.innerHTML = `
        <div class="admin-section">
            <h2>Manage Reviews</h2>
            <div class="admin-form-group">
                <label>Filter by Business ID:</label>
                <input type="number" id="review-filter" placeholder="Enter Business ID">
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Biz ID</th>
                        <th>Rating</th>
                        <th>Text</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="review-table-body">
                    ${renderRows(reviews)}
                </tbody>
            </table>
        </div>
    `;

    function renderRows(reviewList) {
        return reviewList.map(r => `
            <tr>
                <td>${r.id}</td>
                <td>${r.businessId}</td>
                <td>${r.rating}</td>
                <td>${r.text.substring(0, 50)}...</td>
                <td>${r.isHidden ? '<span style="color:red">Hidden</span>' : 'Visible'}</td>
                <td class="admin-actions">
                    <button class="btn-sm btn-secondary btn-toggle" data-id="${r.id}">
                        ${r.isHidden ? 'Unhide' : 'Hide'}
                    </button>
                    <button class="btn-sm btn-danger" data-id="${r.id}">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    const filterInput = container.querySelector('#review-filter');
    const tbody = container.querySelector('#review-table-body');

    filterInput.addEventListener('input', (e) => {
        const val = e.target.value;
        const filtered = val ? reviews.filter(r => r.businessId == val) : reviews;
        tbody.innerHTML = renderRows(filtered);
        attachListeners();
    });

    function attachListeners() {
        tbody.querySelectorAll('.btn-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                toggleReviewVisibility(parseInt(btn.dataset.id));
                renderReviewAdmin(container);
            });
        });

        tbody.querySelectorAll('.btn-danger').forEach(btn => {
            btn.addEventListener('click', () => {
                if(confirm('Are you sure?')) {
                    deleteReview(parseInt(btn.dataset.id));
                    renderReviewAdmin(container);
                }
            });
        });
    }

    attachListeners();
}







function createNavigation() {
  const currentHash = window.location.hash || '#/home'
  const favoritesCount = getFavorites().length
  
  return `
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <a href="#/home" class="navbar-logo">
            <span class="logo-icon">üè™</span>
            <span class="logo-text">Byte-Sized Business Boost</span>
          </a>
        </div>
        
        <ul class="navbar-menu">
          <li class="navbar-item">
            <a href="#/home" class="navbar-link ${currentHash === '#/home' ? 'active' : ''}">
              Home
            </a>
          </li>
          <li class="navbar-item">
            <a href="#/favorites" class="navbar-link ${currentHash === '#/favorites' ? 'active' : ''}">
              Favorites
              ${favoritesCount > 0 ? `<span class="navbar-badge">${favoritesCount}</span>` : ''}
            </a>
          </li>
          <li class="navbar-item">
            <a href="#/admin" class="navbar-link ${currentHash === '#/admin' ? 'active' : ''}">
              Admin
            </a>
          </li>
          <li class="navbar-item">
            <a href="#/judge" class="navbar-link ${currentHash === '#/judge' ? 'active' : ''}">
              Judge
            </a>
          </li>
        </ul>
      </div>
    </nav>
  `
}


function updateFavoritesBadge() {
  const favoritesLink = document.querySelector('a[href="#/favorites"]')
  if (!favoritesLink) return
  
  const favoritesCount = getFavorites().length
  let badge = favoritesLink.querySelector('.navbar-badge')
  
  if (favoritesCount > 0) {
    if (badge) {
      badge.textContent = favoritesCount
    } else {
      badge = document.createElement('span')
      badge.className = 'navbar-badge'
      badge.textContent = favoritesCount
      favoritesLink.appendChild(badge)
    }
  } else if (badge) {
    badge.remove()
  }
}


function updateActiveNavLink() {
  const currentHash = window.location.hash || '#/home'
  const links = document.querySelectorAll('.navbar-link')
  
  links.forEach(link => {
    const href = link.getAttribute('href')
    if (href === currentHash) {
      link.classList.add('active')
    } else {
      link.classList.remove('active')
    }
  })
}














let businessData = []


let allBusinessesWithDistance = []


let currentUserLocation = null


let currentSortMode = 'category'


let isLocationEnabled = false


async function loadHomePage() {
    const app = document.getElementById('app');
    
    
    app.innerHTML = `
        <div class="hero">
            <h1>Discover Local Gems</h1>
            <p>Support your community, one business at a time.</p>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search businesses..." aria-label="Search businesses">
            </div>
        </div>

        <div class="container">
            <!-- Location Permission Prompt -->
            <div id="location-prompt-container"></div>

            <!-- Location Loading Indicator -->
            <div id="location-loader-container"></div>

            <!-- Deals Banner -->
            <div id="deal-banner" class="deal-banner hidden"></div>

            <!-- Location Search Controls -->
            <div id="location-search-container"></div>

            <!-- Controls -->
            <div class="controls flex-between mb-md">
                <div class="sort-wrapper">
                    <label for="sort-select" class="sr-only">Sort by</label>
                    <select id="sort-select" class="input">
                        <option value="category">Sort by Category</option>
                        <option value="rating">Sort by Rating</option>
                        <option value="alpha">Sort A-Z</option>
                        <option value="newest">Newest First</option>
                        <option value="distance">Sort by Distance</option>
                    </select>
                </div>
            </div>

            <!-- Main Grid -->
            <div id="business-grid" class="grid"></div>

            <!-- Trending Section -->
            <section class="mt-lg">
                <h2 class="mb-md">Trending Now</h2>
                <div id="trending-list" class="grid grid-cols-2"></div>
            </section>

            <!-- Recommendations Section (Lazy) -->
            <section id="recommendation-section" class="mt-lg hidden">
                <h2 class="mb-md">Recommended for You</h2>
                <div id="recommendation-grid" class="grid"></div>
            </section>
        </div>
    `;

    
    const [businesses, deals, reviews] = await Promise.all([
        loadBusinesses(),
        loadDeals(),
        loadReviews()
    ]);
    
    businessData = businesses;

    
    const promptContainer = document.getElementById('location-prompt-container');
    const loaderContainer = document.getElementById('location-loader-container');
    
    
    promptContainer.appendChild(locationPermissionPrompt(async () => {
        loaderContainer.appendChild(locationLoadingIndicator());
        currentUserLocation = await getUserLocation();
        if (currentUserLocation) {
            isLocationEnabled = true;
            loaderContainer.innerHTML = '';
            promptContainer.innerHTML = '';
            allBusinessesWithDistance = addDistancesToBusinesses(businessData, currentUserLocation, 'M');
            setupLocationSearch();
            renderBusinessGrid(allBusinessesWithDistance);
        }
    }));

    
    renderBusinessGrid(businessData);

    
    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const dataSource = isLocationEnabled ? allBusinessesWithDistance : businessData;
        const filtered = dataSource.filter(b => 
            b.name.toLowerCase().includes(term) || 
            b.category.toLowerCase().includes(term) ||
            b.description.toLowerCase().includes(term)
        );
        renderBusinessGrid(filtered);
    });

    document.getElementById('sort-select').addEventListener('change', (e) => {
        currentSortMode = e.target.value;
        const dataSource = isLocationEnabled ? allBusinessesWithDistance : businessData;
        const sorted = sortBusinesses(dataSource, currentSortMode);
        renderBusinessGrid(sorted);
    });

    
    renderDeals(deals, businesses);

    
    renderTrendingSection(reviews, businesses);

    
    
    
    import('../services/recommendationService.js').then(async ({ getRecommendedBusinesses }) => {
        import('../components/recommendationCard.js').then(({ recommendationCard }) => {
             renderRecommendations(getRecommendedBusinesses, recommendationCard);
        });
    }).catch(err => console.log("Recommendation service failed to load", err));
}


function setupLocationSearch() {
    const container = document.getElementById('location-search-container');
    if (!container || !currentUserLocation) return;

    container.appendChild(locationSearch(allBusinessesWithDistance, currentUserLocation, (action) => {
        const sortSelect = document.getElementById('sort-select');
        
        if (action === 'sort-distance') {
            sortSelect.value = 'distance';
            const sorted = sortBusinesses(allBusinessesWithDistance, 'distance');
            renderBusinessGrid(sorted);
        } else if (typeof action === 'number') {
            
            const filtered = filterByDistance(allBusinessesWithDistance, action);
            renderBusinessGrid(filtered);
        }
    }));
}


function renderBusinessGrid(list) {
    const grid = document.getElementById('business-grid');
    grid.innerHTML = ''; 
    
    
    if (!list || list.length === 0) {
        grid.innerHTML = '<p>No businesses found.</p>';
        return;
    }

    
    const fragment = document.createDocumentFragment();
    list.forEach(business => {
        fragment.appendChild(businessCard(business));
    });
    
    grid.appendChild(fragment);
}


function sortBusinesses(businesses, mode) {
    
    const clone = [...businesses];
    switch (mode) {
        case 'rating': return clone.sort((a, b) => b.rating - a.rating); 
        case 'alpha': return clone.sort((a, b) => a.name.localeCompare(b.name)); 
        case 'newest': return clone.sort((a, b) => b.id - a.id); 
        case 'distance': return sortByDistance(clone); 
        case 'category': default: return clone.sort((a, b) => a.category.localeCompare(b.category)); 
    }
}


function renderDeals(deals, businesses) {
    const banner = document.getElementById('deal-banner');
    if (!banner) return; 

    
    const activeDeals = getActiveDeals(deals);
    
    if (activeDeals.length === 0) return; 

    const deal = activeDeals[0]; 
    const business = businesses.find(b => b.id == deal.businessId);
    
    
    if (business) {
        banner.innerHTML = `
            <div class="flex-between">
                <span><strong>${deal.title}</strong> at ${business.name}: ${deal.description}</span>
                <button class="button button-sm button-outline" onclick="location.hash='#/business/${business.id}'">View</button>
            </div>
        `;
        banner.classList.remove('hidden'); 
    }
}


function renderTrendingSection(allReviews, businesses) {
    const list = document.getElementById('trending-list');
    if (!list) return; 

    
    const trending = businesses
        .map(b => ({
            business: b,
            count: allReviews.filter(r => r.businessId == b.id).length 
        }))
        .sort((a, b) => b.count - a.count) 
        .slice(0, 2); 

    if (trending.length === 0) {
        list.innerHTML = '<p>No trending data yet.</p>';
        return;
    }

    trending.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card p-sm';
        div.innerHTML = `
            <h4>${item.business.name}</h4>
            <p>${item.count} reviews</p>
        `;
        
        div.onclick = () => location.hash = `#/business/${item.business.id}`;
        list.appendChild(div);
    });
}


async function renderRecommendations(getRecommendedBusinesses, recommendationCard) {
    const section = document.getElementById('recommendation-section');
    const grid = document.getElementById('recommendation-grid');
    if (!section || !grid) return; 
    
    try {
        
        const recommendations = await getRecommendedBusinesses(3);
        if (recommendations && recommendations.length > 0) {
            section.classList.remove('hidden'); 
            grid.innerHTML = ''; 
            recommendations.forEach(rec => {
                
                grid.appendChild(recommendationCard(rec));
            });
        }
        
    } catch (e) {
        
        console.warn("Recs failed", e);
    }
}
















const REVIEW_IMAGE_OPTIONS = [
  'review-photo-1.svg',
  'review-photo-2.svg',
  'review-photo-3.svg'
]


async function loadBusinessPage(id) {
  const business = await getBusinessById(id)
  if (!business) {
    document.getElementById('app').innerHTML = '<p>Business not found.</p>'
    return
  }

  
  recordView(business.id)

  const container = document.getElementById('app')

  await loadDeals()

  const imageUrl = business.image.startsWith('http') ? business.image : `/assets/${business.image}`
  container.innerHTML = `
    <div class="fade-in">
      <div class="mb-lg">
        <button id="back-btn" class="button button-outline mb-md">‚Üê Back to Home</button>
        
        <div class="card flex-between flex-wrap gap-md">
          <div class="flex gap-md flex-wrap">
            <img src="${imageUrl}" alt="${business.name}" style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--radius-md);">
            <div>
              <h1 class="mb-sm">${business.name}</h1>
              <p class="text-light mb-sm">${business.category} ‚Ä¢ ${business.subcategory || 'General'}</p>
              <p class="mb-0">${business.description}</p>
            </div>
          </div>
          <button id="bookmark-btn" class="button button-secondary">Bookmark</button>
        </div>
      </div>

      <div class="grid grid-3">
        <div class="section" style="grid-column: span 2;">
          <h2 class="mb-md">Reviews</h2>
          <div id="reviews-list" class="grid gap-md mb-lg"></div>
          
          <div class="card">
            <h3 class="mb-md">Write a Review</h3>
            <form id="review-form">
              <div class="grid grid-2 mb-md">
                <div>
                  <label for="review-rating" class="mb-sm block">Rating</label>
                  <select id="review-rating" name="rating" class="select">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                    <option value="2">‚≠ê‚≠ê (2)</option>
                    <option value="1">‚≠ê (1)</option>
                  </select>
                </div>
                <div>
                  <label for="review-image" class="mb-sm block">Photo</label>
                  <select id="review-image" name="reviewImage" class="select">
                    ${REVIEW_IMAGE_OPTIONS.map(image => `<option value="${image}">${image.replace('review-photo-', '').replace('.svg', '')}</option>`).join('')}
                  </select>
                </div>
              </div>
              
              <div class="mb-md">
                <label for="review-text" class="mb-sm block">Your Experience</label>
                <textarea id="review-text" name="reviewText" rows="3" class="textarea" placeholder="Share your experience..."></textarea>
              </div>

              <div class="flex-between flex-wrap gap-md">
                <div class="flex-center gap-sm">
                  <span id="captcha-prompt" class="text-light font-bold"></span>
                  <input id="captcha-input" name="captcha" class="input" style="width: 100px;" placeholder="Answer" />
                </div>
                <button type="submit" class="button button-primary">Submit Review</button>
              </div>
              <p id="review-error" class="mt-sm font-bold"></p>
            </form>
          </div>
        </div>

        <div class="section">
          <div class="card mb-lg">
            <h3 class="mb-md">Active Deals</h3>
            <ul id="deal-list" style="list-style: none; padding: 0;"></ul>
          </div>

          <div class="card">
            <h3 class="mb-md">Similar Businesses</h3>
            <div id="similar-list" class="grid gap-md"></div>
          </div>
        </div>
      </div>
    </div>
  `

  document.getElementById('back-btn').addEventListener('click', () => location.hash = '#/home')

  document
    .getElementById('bookmark-btn')
    .addEventListener('click', async () => {
      saveFavorite(business.id)
      
      const btn = document.getElementById('bookmark-btn')
      btn.textContent = '‚úì Bookmarked!'
      btn.style.background = 'var(--success)'
      setTimeout(() => {
        btn.textContent = 'üîñ Bookmark'
        btn.style.background = ''
      }, 2000)
      
      
      try {
        const { updateFavoritesBadge } = await import('../components/navigation.js')
        updateFavoritesBadge()
      } catch (e) {
        
      }
    })

  renderDeals(business.id)
  await renderReviews(business.id)
  await renderSimilarBusinesses(business)

  let captchaData = generateCaptcha()
  const captchaPrompt = document.getElementById('captcha-prompt')
  const errorNode = document.getElementById('review-error')
  updateCaptchaPrompt(captchaPrompt, captchaData)

  document.getElementById('review-form').addEventListener('submit', async (event) => {
    event.preventDefault()
    errorNode.textContent = ''
    try {
      const rating = validateRating(document.getElementById('review-rating').value)
      const text = validateReviewText(document.getElementById('review-text').value)
      const image = document.getElementById('review-image').value
      const captchaValue = validateRequired(document.getElementById('captcha-input').value)
      validateCaptcha(captchaValue, captchaData)

      await addReview(business.id, { rating, text, image })
      await renderReviews(business.id)
      notifyReviewsUpdated()

      document.getElementById('review-form').reset()
      document.getElementById('review-image').value = REVIEW_IMAGE_OPTIONS[0]
      captchaData = generateCaptcha()
      updateCaptchaPrompt(captchaPrompt, captchaData)
      errorNode.textContent = 'Review submitted!'
      errorNode.classList.remove('form-error')
      errorNode.classList.add('form-success')
    } catch (error) {
      errorNode.textContent = error.message
      errorNode.classList.remove('form-success')
      errorNode.classList.add('form-error')
    }
  })
}


async function renderReviews(businessId) {
  const list = document.getElementById('reviews-list')
  const reviews = await getReviewsForBusiness(businessId)
  const sorted = sortReviewsByCredibility(reviews) 
  list.innerHTML = '' 
  
  
  if (!sorted.length) {
    list.textContent = 'No reviews yet. Be the first to share one!'
    return
  }
  
  
  sorted.forEach(review => list.appendChild(reviewCard(review)))
  
  
  attachReviewListeners(list, businessId)
}


function attachReviewListeners(container, businessId) {
  container.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const reviewId = button.closest('.review-card')?.dataset?.reviewId
      if (!reviewId) return
      try {
        await likeReview(reviewId)
        await renderReviews(businessId)
        notifyReviewsUpdated()
      } catch (error) {
        console.error(error)
      }
    })
  })
  container.querySelectorAll('.comment-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const reviewId = button.closest('.review-card')?.dataset?.reviewId
      if (!reviewId) return
      const comment = prompt('Add a comment')
      if (!comment) {
        return
      }
      const trimmed = comment.trim()
      if (!trimmed) {
        return
      }
      try {
        await commentOnReview(reviewId, trimmed)
        await renderReviews(businessId)
        notifyReviewsUpdated()
      } catch (error) {
        console.error(error)
      }
    })
  })
}


function renderDeals(businessId) {
  const list = document.getElementById('deal-list')
  
  const activeDeals = getActiveDeals().filter(deal => String(deal.businessId) === String(businessId))
  list.innerHTML = ''
  
  
  if (!activeDeals.length) {
    list.innerHTML = '<li>No active deals right now.</li>'
    return
  }
  
  
  activeDeals.forEach(deal => {
    const item = document.createElement('li')
    item.textContent = `${deal.title} (${deal.startDate} ‚Üí ${deal.endDate})`
    list.appendChild(item)
  })
}


function updateCaptchaPrompt(node, captchaData) {
  node.textContent = captchaData.prompt
}


function notifyReviewsUpdated() {
  window.dispatchEvent(new Event('reviews-updated'))
}


async function renderSimilarBusinesses(currentBusiness) {
  const list = document.getElementById('similar-list')
  if (!list) return 

  
  const allBusinesses = await loadBusinesses()
  
  
  const similar = allBusinesses.filter(b => 
    b.category === currentBusiness.category && 
    String(b.id) !== String(currentBusiness.id) 
  ).slice(0, 3) 

  list.innerHTML = ''
  
  
  if (similar.length === 0) {
    list.innerHTML = '<p>No similar businesses found.</p>'
    return
  }

  
  
  similar.forEach(biz => {
    list.appendChild(businessCard(biz))
  })
}









async function loadFavoritesPage() {
  const app = document.getElementById('app')
  
  
  const favoriteIds = getFavorites()
  const allBusinesses = await loadBusinesses()
  
  
  const favoriteBusinesses = allBusinesses.filter(business => 
    favoriteIds.includes(business.id)
  )
  
  
  app.innerHTML = `
    <div class="container mt-lg">
      <div class="flex-between mb-lg">
        <h1>My Favorites</h1>
        <button id="back-btn" class="button button-secondary">
          <span>‚Üê Back</span>
        </button>
      </div>
      
      ${favoriteBusinesses.length === 0 ? `
        <div class="empty-state text-center py-2xl">
          <div class="empty-state-icon mb-md">üîñ</div>
          <h2 class="mb-sm">No Favorites Yet</h2>
          <p class="text-light mb-lg">
            Start bookmarking businesses you love to see them here!
          </p>
          <a href="#/home" class="button button-primary">
            Discover Businesses
          </a>
        </div>
      ` : `
        <p class="text-light mb-md">
          You have ${favoriteBusinesses.length} bookmarked ${favoriteBusinesses.length === 1 ? 'business' : 'businesses'}
        </p>
        <div id="favorites-grid" class="grid grid-cols-3"></div>
      `}
    </div>
  `
  
  
  const backBtn = document.getElementById('back-btn')
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      window.location.hash = '#/home'
    })
  }
  
  
  if (favoriteBusinesses.length > 0) {
    renderFavoriteBusinesses(favoriteBusinesses)
  }
}


function renderFavoriteBusinesses(businesses) {
  const grid = document.getElementById('favorites-grid')
  
  businesses.forEach(business => {
    
    const card = businessCard(business)
    
    
    const removeBtn = document.createElement('button')
    removeBtn.className = 'button button-outline button-small mt-sm'
    removeBtn.textContent = 'Remove from Favorites'
    removeBtn.style.width = '100%'
    
    removeBtn.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      
      
      removeFavorite(business.id)
      
      
      card.style.opacity = '0.5'
      removeBtn.textContent = 'Removed!'
      removeBtn.disabled = true
      
      
      setTimeout(() => {
        loadFavoritesPage()
      }, 500)
    })
    
    card.appendChild(removeBtn)
    grid.appendChild(card)
  })
}








function renderJudgePage() {
    
    if (!document.getElementById('judge-css')) {
        const link = document.createElement('link');
        link.id = 'judge-css';
        link.rel = 'stylesheet';
        link.href = 'css/judge.css';
        document.head.appendChild(link);
    }

    
    document.body.innerHTML = `
        <div class="judge-container">
            <div class="judge-steps-panel" id="judge-steps">
                <div class="judge-steps-header">
                    <h3>Guided Demo</h3>
                    <p>Follow the script below.</p>
                </div>
                <!-- Steps injected here -->
            </div>
            
            <div class="judge-app-view">
                <div class="judge-controls">
                    <button id="reset-env-btn" class="control-btn danger">Reset Environment</button>
                    <button id="toggle-offline-btn" class="control-btn">Simulate Offline</button>
                </div>
                <div class="app-frame-container">
                    <iframe id="app-frame" src="index.html#/" title="Live App Preview"></iframe>
                </div>
            </div>
            
            <div class="judge-notes-panel">
                <h3>Judge's Rubric Notes</h3>
                
                <div class="note-category">
                    <h4>Code Quality</h4>
                    <div class="note-item">Modular ES6+ Architecture</div>
                    <div class="note-item">No External Libraries (Pure JS)</div>
                    <div class="note-item">Efficient DOM Manipulation</div>
                </div>

                <div class="note-category">
                    <h4>UX & Accessibility</h4>
                    <div class="note-item">Responsive Mobile-First Design</div>
                    <div class="note-item">ARIA Labels & Semantic HTML</div>
                    <div class="note-item">Offline Fallbacks & PWA Support</div>
                </div>

                <div class="note-category">
                    <h4>Functionality</h4>
                    <div class="note-item">Search, Sort, & Filter</div>
                    <div class="note-item">Admin CRUD Operations</div>
                    <div class="note-item">Data Persistence (LocalStorage)</div>
                </div>

                <div class="note-category">
                    <h4>Data Analysis</h4>
                    <div class="note-item">Credibility Scoring Algorithm</div>
                    <div class="note-item">Recommendation Engine</div>
                    <div class="note-item">Admin Analytics Dashboard</div>
                </div>
            </div>
        </div>
    `;

    
    renderSteps();
    setupControls();
}


function renderSteps() {
    const container = document.getElementById('judge-steps');
    const frame = document.getElementById('app-frame');

    DEMO_STEPS.forEach((step, index) => {
        const stepEl = document.createElement('div');
        stepEl.className = 'step-item';
        stepEl.innerHTML = `
            <div class="step-title">${index + 1}. ${step.title}</div>
            <div class="step-desc">${step.description}</div>
            <button class="step-btn">Show This Step</button>
        `;

        stepEl.querySelector('.step-btn').addEventListener('click', () => {
            
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            stepEl.classList.add('active');

            
            const currentHash = frame.contentWindow.location.hash;
            const targetHash = '#' + step.path;
            
            if (currentHash !== targetHash) {
                
                frame.contentWindow.location.hash = targetHash;
                
                setTimeout(() => {
                    step.action(frame);
                }, 500);
            } else {
                
                step.action(frame);
            }
        });

        container.appendChild(stepEl);
    });
}


function setupControls() {
    
    document.getElementById('reset-env-btn').addEventListener('click', () => {
        
        if (confirm("Reset all user data and restart demo?")) {
            resetAllData(); 
        }
    });

    
    document.getElementById('toggle-offline-btn').addEventListener('click', () => {
        const frame = document.getElementById('app-frame');
        
        
        
        
        
        if (frame.contentWindow.showOfflineBanner) {
            frame.contentWindow.showOfflineBanner();
            alert("Simulated Offline Mode: Banner shown.");
        } else {
            
            
            const doc = frame.contentDocument;
            const banner = doc.createElement('div');
            banner.style.cssText = "position:fixed;top:0;left:0;width:100%;background:#ff8800;color:white;text-align:center;padding:10px;z-index:9999;";
            banner.innerText = "Offline Mode (Simulated)";
            doc.body.prepend(banner);
        }
    });
}












async function renderAdminPage() {
    const mainContent = document.getElementById('main-content');
    
    
    if (!document.getElementById('admin-css')) {
        const link = document.createElement('link');
        link.id = 'admin-css';
        link.rel = 'stylesheet';
        link.href = 'css/admin.css';
        document.head.appendChild(link);
    }

    if (!isAdmin()) {
        renderLogin(mainContent);
    } else {
        renderDashboard(mainContent);
    }
}


function renderLogin(container) {
    container.innerHTML = `
        <div class="admin-container">
            <div class="admin-login-container">
                <h2>Admin Login</h2>
                <form class="admin-login-form" id="admin-login-form">
                    <input type="password" id="admin-password" placeholder="Enter Password" required>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <p id="login-error" class="error-message"></p>
            </div>
        </div>
    `;

    document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('admin-password').value;
        const success = await loginAdmin(password);
        if (success) {
            renderDashboard(container);
        } else {
            document.getElementById('login-error').textContent = "Invalid password";
        }
    });
}


function renderDashboard(container) {
    container.innerHTML = `
        <div class="admin-container">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
                <button id="admin-logout" class="btn btn-secondary">Logout</button>
            </div>
            
            <div class="admin-nav">
                <button class="admin-tab-btn active" data-tab="businesses">Businesses</button>
                <button class="admin-tab-btn" data-tab="deals">Deals</button>
                <button class="admin-tab-btn" data-tab="reviews">Reviews</button>
                <button class="admin-tab-btn" data-tab="analytics">Analytics</button>
                <button class="admin-tab-btn" data-tab="settings">Settings & Import/Export</button>
            </div>

            <div id="admin-tab-content" class="admin-content">
                <!-- Content loaded here -->
            </div>
        </div>
    `;

    document.getElementById('admin-logout').addEventListener('click', logoutAdmin);

    const tabs = document.querySelectorAll('.admin-tab-btn');
    const contentDiv = document.getElementById('admin-tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadTab(tab.dataset.tab, contentDiv);
        });
    });

    
    
    loadTab('businesses', contentDiv);
}


async function loadTab(tabName, container) {
    container.innerHTML = '<p>Loading...</p>';
    
    switch(tabName) {
        case 'businesses':
            await renderBusinessAdmin(container);
            break;
        case 'deals':
            await renderDealAdmin(container);
            break;
        case 'reviews':
            await renderReviewAdmin(container);
            break;
        case 'analytics':
            await renderAnalytics(container);
            break;
        case 'settings':
            await renderSettings(container);
            break;
    }
}


async function renderSettings(container) {
    container.innerHTML = `
        <div class="admin-section">
            <h2>Data Management</h2>
            
            <div class="admin-form-group">
                <h3>Export Data</h3>
                <div class="admin-actions">
                    <button id="export-biz" class="btn btn-primary">Export Businesses</button>
                    <button id="export-deals" class="btn btn-primary">Export Deals</button>
                    <button id="export-reviews" class="btn btn-primary">Export Reviews</button>
                </div>
            </div>

            <div class="admin-form-group">
                <h3>Import Data</h3>
                <input type="file" id="import-file" accept=".json">
                <select id="import-type">
                    <option value="businesses">Businesses</option>
                    <option value="deals">Deals</option>
                    <option value="reviews">Reviews</option>
                </select>
                <button id="import-btn" class="btn btn-secondary">Import</button>
                <p id="import-status"></p>
            </div>

            <div class="admin-form-group">
                <h3>System Integrity</h3>
                <button id="check-integrity" class="btn btn-secondary">Run Integrity Checks</button>
                <div id="integrity-results" class="integrity-results"></div>
            </div>
        </div>
    `;

    
    const setupExport = (id, type) => {
        container.querySelector(id).addEventListener('click', async () => {
            const url = await exportData(type);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_export.json`;
            a.click();
        });
    };
    setupExport('#export-biz', 'businesses');
    setupExport('#export-deals', 'deals');
    setupExport('#export-reviews', 'reviews');

    
    container.querySelector('#import-btn').addEventListener('click', () => {
        const fileInput = container.querySelector('#import-file');
        const type = container.querySelector('#import-type').value;
        const status = container.querySelector('#import-status');

        if (fileInput.files.length === 0) {
            status.textContent = "Please select a file.";
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const result = importData(e.target.result, type);
            if (result.success) {
                status.textContent = "Import successful!";
                status.style.color = "green";
            } else {
                status.textContent = "Error: " + result.error;
                status.style.color = "red";
            }
        };
        reader.readAsText(fileInput.files[0]);
    });

    
    container.querySelector('#check-integrity').addEventListener('click', async () => {
        const resultsDiv = container.querySelector('#integrity-results');
        resultsDiv.innerHTML = 'Running checks...';
        
        
        const issues = await runIntegrityChecks();
        
        if (issues.length === 0) {
            
            resultsDiv.innerHTML = '<div class="integrity-ok">‚úì No issues found.</div>';
        } else {
            
            resultsDiv.innerHTML = `
                <div style="color: #dc3545; font-weight: bold; margin-bottom: 0.5rem;">‚ö† ${issues.length} issues detected:</div>
                ${issues.map(i => `<div class="integrity-issue">- ${i}</div>`).join('')}
            `;
        }
    });
}












const routes = {
  home: loadHomePage,        
  business: loadBusinessPage, 
  favorites: loadFavoritesPage, 
  admin: renderAdminPage,     
  judge: renderJudgePage      
}


function renderNavigation() {
  let navContainer = document.getElementById('nav-container')
  
  if (!navContainer) {
    navContainer = document.createElement('div')
    navContainer.id = 'nav-container'
    document.body.insertBefore(navContainer, document.body.firstChild)
  }
  
  navContainer.innerHTML = createNavigation()
}


function handleRoute() {
  
  renderNavigation()
  
  
  
  const hash = window.location.hash || '#/home'
  
  
  
  const parts = hash.slice(2).split('/')

  
  const route = parts[0]      
  const param = parts[1] || null 

  
  if (route === 'business' && param) {
    
    routes.business(param)
  } else if (routes[route]) {
    
    routes[route]()
  } else {
    
    
    routes.home()
  }
  
  
  updateActiveNavLink()
  updateFavoritesBadge()
}


function initRouter() {
  
  window.addEventListener('hashchange', handleRoute)
  
  
  
  handleRoute()
}









document.addEventListener('DOMContentLoaded', () => {
    
    
    initRouter();
    
    
    
    initChatbot();
    
    
    
    initOfflineDetection();

    
    if ("serviceWorker" in navigator) {
        
        navigator.serviceWorker.register("/service-worker.js")
            .then(registration => {
                
                
                console.log("Service Worker registered with scope:", registration.scope);
            })
            .catch(error => {
                
                console.error("Service Worker registration failed:", error);
            });
    }
});


if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof initRouter === 'function') initRouter();
    if (typeof initChatbot === 'function') initChatbot();
    if (typeof initOfflineDetection === 'function') initOfflineDetection();
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    }
  });
} else {
  
  if (typeof initRouter === 'function') initRouter();
  if (typeof initChatbot === 'function') initChatbot();
  if (typeof initOfflineDetection === 'function') initOfflineDetection();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('Service Worker registered with scope:', registration.scope);
      })
      .catch(error => {
        console.error('Service Worker registration failed:', error);
      });
  }
}
})();